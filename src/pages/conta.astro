---
import GameLayout from '../layouts/GameLayout.astro';
import Header from '../components/Header.astro';
---

<GameLayout title="Conta gli Oggetti">
    <div class="app-container">
        <Header title="Conta gli Oggetti">
            <div class="score-display">Punti: <span id="score">0</span></div>
        </Header>
        <main class="game-container">
            <div class="objects-area" id="objectsArea"></div>
            <div class="numbers-container" id="numbersContainer"></div>
        </main>
        <div class="celebration-container" id="celebrationContainer"></div>
    </div>
</GameLayout>

<style>
    .score-display { background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px; color: white; font-weight: 600; }
    .game-container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 15px; gap: 20px; }
    .objects-area { background: white; border-radius: 25px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 15px; min-height: 200px; max-width: 400px; width: 100%; }
    :global(.object-item) { width: 60px; height: 60px; animation: popIn 0.3s ease backwards; }
    :global(.object-item svg) { width: 100%; height: 100%; }
    @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 70% { transform: scale(1.2); } 100% { transform: scale(1); opacity: 1; } }
    .numbers-container { display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; max-width: 400px; }
    :global(.number-btn) { width: 70px; height: 70px; border-radius: 50%; border: none; font-size: 2rem; font-weight: 700; color: white; cursor: pointer; box-shadow: 0 4px 20px rgba(0,0,0,0.2); transition: transform 0.15s; }
    :global(.number-btn:active) { transform: scale(0.92); }
    :global(.number-btn.correct) { animation: correctPulse 0.5s; }
    :global(.number-btn.wrong) { animation: shake 0.5s; }
    @keyframes correctPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-10px); } 40%, 80% { transform: translateX(10px); } }
    :global(.number-btn:nth-child(1)) { background: linear-gradient(145deg, #ef4444, #dc2626); }
    :global(.number-btn:nth-child(2)) { background: linear-gradient(145deg, #f97316, #ea580c); }
    :global(.number-btn:nth-child(3)) { background: linear-gradient(145deg, #22c55e, #16a34a); }
    :global(.number-btn:nth-child(4)) { background: linear-gradient(145deg, #3b82f6, #2563eb); }
    :global(.number-btn:nth-child(5)) { background: linear-gradient(145deg, #8b5cf6, #7c3aed); }
    .celebration-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000; }
    :global(.celebration-star) { position: absolute; font-size: 40px; animation: celebrateFall 1s ease-out forwards; }
    @keyframes celebrateFall { 0% { opacity: 1; transform: translateY(0) rotate(0) scale(1); } 100% { opacity: 0; transform: translateY(150px) rotate(360deg) scale(0.5); } }
</style>

<script>
    const objects = {
        apple: `<svg viewBox="0 0 100 100"><ellipse cx="50" cy="55" rx="35" ry="38" fill="#ef4444"/><path d="M50 20 Q55 5 65 10" stroke="#22c55e" stroke-width="4" fill="none"/><ellipse cx="60" cy="15" rx="12" ry="8" fill="#22c55e"/></svg>`,
        star: `<svg viewBox="0 0 100 100"><polygon points="50,5 61,40 98,40 68,62 79,97 50,75 21,97 32,62 2,40 39,40" fill="#fbbf24"/></svg>`,
        ball: `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="#3b82f6"/><ellipse cx="35" cy="40" rx="15" ry="20" fill="#60a5fa" opacity="0.6"/></svg>`,
        car: `<svg viewBox="0 0 100 100"><rect x="10" y="40" width="80" height="30" rx="5" fill="#ef4444"/><path d="M20 40 L30 25 L70 25 L80 40" fill="#ef4444"/><circle cx="25" cy="70" r="12" fill="#374151"/><circle cx="75" cy="70" r="12" fill="#374151"/></svg>`,
        flower: `<svg viewBox="0 0 100 100"><rect x="47" y="55" width="6" height="35" fill="#22c55e"/><circle cx="50" cy="35" r="12" fill="#fbbf24"/><ellipse cx="50" cy="15" rx="10" ry="15" fill="#ec4899"/><ellipse cx="30" cy="28" rx="10" ry="15" fill="#ec4899" transform="rotate(-60 30 28)"/><ellipse cx="70" cy="28" rx="10" ry="15" fill="#ec4899" transform="rotate(60 70 28)"/></svg>`
    };

    let currentCount = 0, score = 0, canAnswer = true;
    const objectsArea = document.getElementById('objectsArea');
    const numbersContainer = document.getElementById('numbersContainer');
    const scoreDisplay = document.getElementById('score');
    const celebrationContainer = document.getElementById('celebrationContainer');

    function initGame() {
        score = 0; scoreDisplay.textContent = score;
        numbersContainer.innerHTML = '';
        for (let i = 1; i <= 5; i++) {
            const btn = document.createElement('button'); btn.className = 'number-btn'; btn.textContent = i;
            btn.addEventListener('click', () => handleAnswer(i, btn));
            numbersContainer.appendChild(btn);
        }
        nextRound();
    }

    function nextRound() {
        canAnswer = true;
        currentCount = Math.floor(Math.random() * 5) + 1;
        const keys = Object.keys(objects);
        const obj = keys[Math.floor(Math.random() * keys.length)];
        objectsArea.innerHTML = '';
        for (let i = 0; i < currentCount; i++) {
            const el = document.createElement('div'); el.className = 'object-item';
            el.innerHTML = objects[obj]; el.style.animationDelay = `${i * 0.1}s`;
            objectsArea.appendChild(el);
        }
        document.querySelectorAll('.number-btn').forEach(b => b.classList.remove('correct', 'wrong'));
    }

    function handleAnswer(num, btn) {
        if (!canAnswer) return;
        if (num === currentCount) {
            canAnswer = false; score++; scoreDisplay.textContent = score;
            btn.classList.add('correct'); celebrate();
            setTimeout(nextRound, 1000);
        } else {
            btn.classList.add('wrong');
            setTimeout(() => btn.classList.remove('wrong'), 500);
        }
    }

    function celebrate() {
        const r = objectsArea.getBoundingClientRect(), cx = r.left + r.width/2, cy = r.top + r.height/2;
        const emojis = ['‚≠ê', 'üåü', '‚ú®', 'üí´'];
        for (let i = 0; i < 12; i++) {
            const star = document.createElement('div'); star.className = 'celebration-star';
            star.textContent = emojis[Math.floor(Math.random() * emojis.length)];
            star.style.left = `${cx + (Math.random()-0.5)*150}px`; star.style.top = `${cy + (Math.random()-0.5)*100}px`;
            celebrationContainer.appendChild(star); setTimeout(() => star.remove(), 1000);
        }
    }

    initGame();
</script>
