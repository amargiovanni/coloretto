---
import GameLayout from '../layouts/GameLayout.astro';
import Header from '../components/Header.astro';
import GameButton from '../components/GameButton.astro';
---

<GameLayout title="Vesti l'Animale">
    <div class="app-container">
        <Header title="Vesti l'Animale">
            <GameButton color="orange" ariaLabel="Cambia animale" id="changeAnimalBtn">
                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
            </GameButton>
        </Header>
        <main class="game-container">
            <div class="stage-area">
                <div class="animal-stage">
                    <div class="animal-svg" id="animalContainer"></div>
                    <div class="accessory-slot slot-hat" id="slotHat"></div>
                    <div class="accessory-slot slot-glasses" id="slotGlasses"></div>
                    <div class="accessory-slot slot-scarf" id="slotScarf"></div>
                </div>
            </div>
            <nav class="accessories-panel">
                <div class="accessories-row" id="accessoriesRow"></div>
            </nav>
        </main>
        <div class="sparkle-container" id="sparkleContainer"></div>
    </div>
</GameLayout>

<style>
    .game-container { flex: 1; display: flex; flex-direction: column; padding: 15px; gap: 15px; overflow: hidden; }
    .stage-area { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; }
    .animal-stage { background: white; border-radius: 25px; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); position: relative; width: 280px; height: 320px; display: flex; align-items: center; justify-content: center; }
    .animal-svg { width: 200px; height: 250px; position: relative; }
    :global(.animal-svg svg) { width: 100%; height: 100%; }
    .accessory-slot { position: absolute; pointer-events: none; }
    .slot-hat { top: 0; left: 50%; transform: translateX(-50%); width: 100px; height: 60px; }
    .slot-glasses { top: 70px; left: 50%; transform: translateX(-50%); width: 90px; height: 40px; }
    .slot-scarf { top: 140px; left: 50%; transform: translateX(-50%); width: 100px; height: 50px; }
    :global(.accessory-slot svg) { width: 100%; height: 100%; }
    .accessories-panel { background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 15px; box-shadow: 0 -5px 30px rgba(0,0,0,0.15); }
    .accessories-row { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; }
    :global(.accessory-item) { width: 65px; height: 65px; background: #f3f4f6; border-radius: 15px; display: flex; align-items: center; justify-content: center; cursor: grab; transition: transform 0.2s ease, box-shadow 0.2s ease; touch-action: none; border: 3px solid transparent; }
    :global(.accessory-item:active) { cursor: grabbing; }
    :global(.accessory-item.dragging) { transform: scale(1.1); box-shadow: 0 8px 30px rgba(0,0,0,0.3); z-index: 100; position: fixed; }
    :global(.accessory-item.selected) { border-color: #667eea; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
    :global(.accessory-item svg) { width: 50px; height: 50px; }
    .sparkle-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000; }
    :global(.sparkle) { position: absolute; font-size: 24px; animation: sparkleAnim 0.8s ease-out forwards; }
    @keyframes sparkleAnim { 0% { opacity: 1; transform: scale(0) rotate(0deg); } 50% { opacity: 1; transform: scale(1.2) rotate(180deg); } 100% { opacity: 0; transform: scale(0.5) rotate(360deg); } }

    @media (max-width: 400px) {
        .animal-stage { width: 240px; height: 280px; padding: 15px; }
        .animal-svg { width: 170px; height: 220px; }
        .slot-hat { width: 85px; height: 50px; }
        .slot-glasses { top: 60px; width: 75px; height: 35px; }
        .slot-scarf { top: 120px; width: 85px; height: 45px; }
        :global(.accessory-item) { width: 55px; height: 55px; }
        :global(.accessory-item svg) { width: 40px; height: 40px; }
        .accessories-row { gap: 8px; }
    }

    @media (min-width: 768px) {
        .animal-stage { width: 350px; height: 400px; }
        .animal-svg { width: 250px; height: 320px; }
        .slot-hat { width: 125px; height: 75px; }
        .slot-glasses { top: 90px; width: 110px; height: 50px; }
        .slot-scarf { top: 175px; width: 125px; height: 60px; }
        :global(.accessory-item) { width: 80px; height: 80px; }
        :global(.accessory-item svg) { width: 60px; height: 60px; }
        .accessories-row { gap: 15px; }
    }

    @media (orientation: landscape) and (max-height: 500px) {
        .game-container { flex-direction: row; padding: 10px; gap: 10px; }
        .animal-stage { width: 200px; height: auto; aspect-ratio: 0.85; }
        .animal-svg { width: 140px; height: 180px; }
        .slot-hat { width: 70px; height: 42px; }
        .slot-glasses { top: 50px; width: 60px; height: 28px; }
        .slot-scarf { top: 100px; width: 70px; height: 35px; }
        .accessories-panel { height: 100%; display: flex; align-items: center; }
        .accessories-row { flex-direction: column; gap: 8px; }
        :global(.accessory-item) { width: 50px; height: 50px; }
        :global(.accessory-item svg) { width: 36px; height: 36px; }
    }
</style>

<script>
    type AccessoryType = 'hat' | 'glasses' | 'scarf';

    interface AccessoryItem {
        id: string;
        svg: string;
    }

    interface Accessories {
        hats: AccessoryItem[];
        glasses: AccessoryItem[];
        scarves: AccessoryItem[];
    }

    interface EquippedAccessories {
        hat: string | null;
        glasses: string | null;
        scarf: string | null;
    }

    const animals: Record<string, string> = {
        bear: `<svg viewBox="0 0 100 130"><circle cx="25" cy="20" r="15" fill="#8B4513"/><circle cx="25" cy="20" r="8" fill="#A0522D"/><circle cx="75" cy="20" r="15" fill="#8B4513"/><circle cx="75" cy="20" r="8" fill="#A0522D"/><ellipse cx="50" cy="55" rx="40" ry="35" fill="#A0522D"/><ellipse cx="50" cy="105" rx="35" ry="25" fill="#8B4513"/><circle cx="35" cy="50" r="5" fill="#1f2937"/><circle cx="65" cy="50" r="5" fill="#1f2937"/><ellipse cx="50" cy="62" rx="10" ry="7" fill="#D2691E"/><ellipse cx="50" cy="60" rx="5" ry="3" fill="#1f2937"/><path d="M44 70 Q50 78 56 70" stroke="#1f2937" stroke-width="2" fill="none"/></svg>`,
        cat: `<svg viewBox="0 0 100 130"><polygon points="20,35 10,5 35,25" fill="#808080"/><polygon points="80,35 90,5 65,25" fill="#808080"/><polygon points="20,32 15,15 32,25" fill="#FFB6C1"/><polygon points="80,32 85,15 68,25" fill="#FFB6C1"/><ellipse cx="50" cy="50" rx="38" ry="32" fill="#909090"/><ellipse cx="50" cy="105" rx="32" ry="25" fill="#808080"/><ellipse cx="35" cy="45" rx="8" ry="10" fill="#90EE90"/><ellipse cx="65" cy="45" rx="8" ry="10" fill="#90EE90"/><ellipse cx="35" cy="47" rx="3" ry="6" fill="#1f2937"/><ellipse cx="65" cy="47" rx="3" ry="6" fill="#1f2937"/><ellipse cx="50" cy="58" rx="5" ry="4" fill="#FFB6C1"/><line x1="25" y1="55" x2="5" y2="50" stroke="#1f2937" stroke-width="2"/><line x1="25" y1="60" x2="5" y2="62" stroke="#1f2937" stroke-width="2"/><line x1="75" y1="55" x2="95" y2="50" stroke="#1f2937" stroke-width="2"/><line x1="75" y1="60" x2="95" y2="62" stroke="#1f2937" stroke-width="2"/></svg>`,
        rabbit: `<svg viewBox="0 0 100 130"><ellipse cx="35" cy="25" rx="10" ry="30" fill="#F5F5F5"/><ellipse cx="35" cy="25" rx="5" ry="22" fill="#FFB6C1"/><ellipse cx="65" cy="25" rx="10" ry="30" fill="#F5F5F5"/><ellipse cx="65" cy="25" rx="5" ry="22" fill="#FFB6C1"/><ellipse cx="50" cy="60" rx="35" ry="30" fill="#F5F5F5"/><ellipse cx="50" cy="105" rx="30" ry="25" fill="#E8E8E8"/><circle cx="38" cy="55" r="5" fill="#1f2937"/><circle cx="62" cy="55" r="5" fill="#1f2937"/><ellipse cx="50" cy="68" rx="6" ry="4" fill="#FFB6C1"/><circle cx="30" cy="75" r="8" fill="#FFB6C1" opacity="0.4"/><circle cx="70" cy="75" r="8" fill="#FFB6C1" opacity="0.4"/><path d="M44 72 Q50 78 56 72" stroke="#1f2937" stroke-width="2" fill="none"/></svg>`
    };

    const accessories: Accessories = {
        hats: [
            { id: 'hat1', svg: `<svg viewBox="0 0 100 60"><ellipse cx="50" cy="50" rx="45" ry="10" fill="#b91c1c"/><path d="M20 50 Q20 15 50 10 Q80 15 80 50" fill="#ef4444"/><circle cx="50" cy="8" r="6" fill="#fbbf24"/></svg>` },
            { id: 'hat2', svg: `<svg viewBox="0 0 100 60"><path d="M10 55 L10 25 L25 40 L40 20 L50 35 L60 20 L75 40 L90 25 L90 55 Z" fill="#fbbf24"/><circle cx="25" cy="22" r="5" fill="#ef4444"/><circle cx="50" cy="18" r="5" fill="#3b82f6"/><circle cx="75" cy="22" r="5" fill="#22c55e"/></svg>` },
            { id: 'hat3', svg: `<svg viewBox="0 0 100 60"><ellipse cx="50" cy="55" rx="40" ry="8" fill="#4338ca"/><path d="M25 55 L50 5 L75 55" fill="#6366f1"/><polygon points="50,15 55,25 45,25" fill="#fbbf24"/><circle cx="35" cy="40" r="4" fill="#fbbf24"/><circle cx="65" cy="35" r="3" fill="#fbbf24"/></svg>` },
        ],
        glasses: [
            { id: 'glasses1', svg: `<svg viewBox="0 0 100 40"><circle cx="25" cy="20" r="15" fill="none" stroke="#1f2937" stroke-width="4"/><circle cx="75" cy="20" r="15" fill="none" stroke="#1f2937" stroke-width="4"/><line x1="40" y1="20" x2="60" y2="20" stroke="#1f2937" stroke-width="4"/><line x1="10" y1="20" x2="0" y2="15" stroke="#1f2937" stroke-width="3"/><line x1="90" y1="20" x2="100" y2="15" stroke="#1f2937" stroke-width="3"/></svg>` },
            { id: 'glasses2', svg: `<svg viewBox="0 0 100 40"><ellipse cx="25" cy="20" rx="18" ry="14" fill="#1f2937"/><ellipse cx="75" cy="20" rx="18" ry="14" fill="#1f2937"/><path d="M43 20 Q50 25 57 20" stroke="#1f2937" stroke-width="4" fill="none"/><line x1="7" y1="18" x2="0" y2="12" stroke="#1f2937" stroke-width="3"/><line x1="93" y1="18" x2="100" y2="12" stroke="#1f2937" stroke-width="3"/></svg>` },
            { id: 'glasses3', svg: `<svg viewBox="0 0 100 40"><polygon points="25,5 28,15 38,15 30,22 33,32 25,26 17,32 20,22 12,15 22,15" fill="#ec4899"/><polygon points="75,5 78,15 88,15 80,22 83,32 75,26 67,32 70,22 62,15 72,15" fill="#ec4899"/><line x1="38" y1="20" x2="62" y2="20" stroke="#ec4899" stroke-width="3"/><line x1="12" y1="18" x2="2" y2="14" stroke="#ec4899" stroke-width="3"/><line x1="88" y1="18" x2="98" y2="14" stroke="#ec4899" stroke-width="3"/></svg>` },
        ],
        scarves: [
            { id: 'scarf1', svg: `<svg viewBox="0 0 100 50"><path d="M10 15 Q50 5 90 15 Q95 25 90 30 Q50 20 10 30 Q5 25 10 15" fill="#ef4444"/><rect x="15" y="30" width="12" height="20" rx="3" fill="#ef4444"/><rect x="73" y="30" width="12" height="20" rx="3" fill="#ef4444"/><line x1="18" y1="35" x2="24" y2="35" stroke="#dc2626" stroke-width="2"/><line x1="18" y1="40" x2="24" y2="40" stroke="#dc2626" stroke-width="2"/><line x1="76" y1="35" x2="82" y2="35" stroke="#dc2626" stroke-width="2"/><line x1="76" y1="40" x2="82" y2="40" stroke="#dc2626" stroke-width="2"/></svg>` },
            { id: 'scarf2', svg: `<svg viewBox="0 0 100 50"><ellipse cx="30" cy="25" rx="25" ry="15" fill="#3b82f6"/><ellipse cx="70" cy="25" rx="25" ry="15" fill="#3b82f6"/><circle cx="50" cy="25" r="8" fill="#1e40af"/><circle cx="20" cy="20" r="3" fill="#60a5fa"/><circle cx="80" cy="20" r="3" fill="#60a5fa"/></svg>` },
            { id: 'scarf3', svg: `<svg viewBox="0 0 100 50"><path d="M10 10 Q50 0 90 10 L90 18 Q50 8 10 18 Z" fill="#ef4444"/><path d="M10 18 Q50 8 90 18 L90 26 Q50 16 10 26 Z" fill="#fbbf24"/><path d="M10 26 Q50 16 90 26 L90 34 Q50 24 10 34 Z" fill="#22c55e"/><path d="M10 34 Q50 24 90 34 L90 42 Q50 32 10 42 Z" fill="#3b82f6"/><rect x="10" y="38" width="10" height="12" rx="2" fill="#3b82f6"/><rect x="80" y="38" width="10" height="12" rx="2" fill="#3b82f6"/></svg>` },
        ]
    };

    let currentAnimal: string = 'bear';
    let equippedAccessories: EquippedAccessories = { hat: null, glasses: null, scarf: null };
    let draggedItem: HTMLElement | null = null;

    const animalContainer = document.getElementById('animalContainer')!;
    const accessoriesRow = document.getElementById('accessoriesRow')!;
    const slotHat = document.getElementById('slotHat')!;
    const slotGlasses = document.getElementById('slotGlasses')!;
    const slotScarf = document.getElementById('slotScarf')!;
    const resetBtn = document.getElementById('resetBtn');
    const changeAnimalBtn = document.getElementById('changeAnimalBtn');
    const sparkleContainer = document.getElementById('sparkleContainer')!;

    function initGame(): void { renderAnimal(); renderAccessories(); clearAccessories(); }

    function renderAnimal(): void { animalContainer.innerHTML = animals[currentAnimal]; }

    function renderAccessories(): void {
        accessoriesRow.innerHTML = '';
        const allAccessories: AccessoryItem[] = [...accessories.hats, ...accessories.glasses, ...accessories.scarves];
        allAccessories.forEach((acc: AccessoryItem) => {
            const item = document.createElement('div');
            item.className = 'accessory-item';
            item.dataset.id = acc.id;
            const accType = getAccessoryType(acc.id);
            if (accType) item.dataset.type = accType;
            item.innerHTML = acc.svg;
            addDragListeners(item);
            accessoriesRow.appendChild(item);
        });
    }

    function getAccessoryType(id: string): AccessoryType | null {
        if (id.startsWith('hat')) return 'hat';
        if (id.startsWith('glasses')) return 'glasses';
        if (id.startsWith('scarf')) return 'scarf';
        return null;
    }

    function getAccessoryById(id: string): AccessoryItem | undefined {
        const all: AccessoryItem[] = [...accessories.hats, ...accessories.glasses, ...accessories.scarves];
        return all.find((a: AccessoryItem) => a.id === id);
    }

    function clearAccessories(): void {
        equippedAccessories = { hat: null, glasses: null, scarf: null };
        slotHat.innerHTML = ''; slotGlasses.innerHTML = ''; slotScarf.innerHTML = '';
        document.querySelectorAll('.accessory-item').forEach((item) => item.classList.remove('selected'));
    }

    function equipAccessory(id: string | undefined): void {
        if (!id) return;
        const type = getAccessoryType(id);
        const accessory = getAccessoryById(id);
        if (!type || !accessory) return;
        document.querySelectorAll(`.accessory-item[data-type="${type}"]`).forEach((item) => item.classList.remove('selected'));
        equippedAccessories[type] = id;
        const slot = type === 'hat' ? slotHat : type === 'glasses' ? slotGlasses : slotScarf;
        slot.innerHTML = accessory.svg;
        const item = document.querySelector(`.accessory-item[data-id="${id}"]`);
        if (item) item.classList.add('selected');
        createSparkles(slot);
    }

    function addDragListeners(element: HTMLElement): void {
        element.addEventListener('touchstart', handleDragStart, { passive: false });
        element.addEventListener('touchmove', handleDragMove, { passive: false });
        element.addEventListener('touchend', handleDragEnd, { passive: false });
        element.addEventListener('mousedown', handleDragStart);
        element.addEventListener('click', () => equipAccessory(element.dataset.id));
    }

    function handleDragStart(e: TouchEvent | MouseEvent): void {
        if (e.type === 'mousedown') { document.addEventListener('mousemove', handleDragMove); document.addEventListener('mouseup', handleDragEnd); }
        e.preventDefault();
        draggedItem = e.currentTarget as HTMLElement;
        draggedItem.classList.add('dragging');
        const clientX = e instanceof TouchEvent ? e.touches[0].clientX : e.clientX;
        const clientY = e instanceof TouchEvent ? e.touches[0].clientY : e.clientY;
        updateDragPosition(clientX, clientY);
    }

    function handleDragMove(e: TouchEvent | MouseEvent): void {
        if (!draggedItem) return;
        e.preventDefault();
        const clientX = e instanceof TouchEvent ? e.touches[0].clientX : e.clientX;
        const clientY = e instanceof TouchEvent ? e.touches[0].clientY : e.clientY;
        updateDragPosition(clientX, clientY);
    }

    function updateDragPosition(x: number, y: number): void {
        if (!draggedItem) return;
        draggedItem.style.left = `${x - draggedItem.offsetWidth / 2}px`;
        draggedItem.style.top = `${y - draggedItem.offsetHeight / 2}px`;
    }

    function handleDragEnd(e: TouchEvent | MouseEvent): void {
        if (!draggedItem) return;
        const clientX = e instanceof TouchEvent ? e.changedTouches[0].clientX : e.clientX;
        const clientY = e instanceof TouchEvent ? e.changedTouches[0].clientY : e.clientY;
        const stage = document.querySelector('.animal-stage');
        if (stage) {
            const stageRect = stage.getBoundingClientRect();
            if (clientX >= stageRect.left && clientX <= stageRect.right && clientY >= stageRect.top && clientY <= stageRect.bottom) {
                equipAccessory(draggedItem.dataset.id);
            }
        }
        draggedItem.style.left = ''; draggedItem.style.top = '';
        draggedItem.classList.remove('dragging');
        draggedItem = null;
        document.removeEventListener('mousemove', handleDragMove);
        document.removeEventListener('mouseup', handleDragEnd);
    }

    function createSparkles(element: HTMLElement): void {
        const rect = element.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        const emojis: string[] = ['âœ¨', 'â­', 'ðŸŒŸ', 'ðŸ’«'];
        for (let i = 0; i < 6; i++) {
            const sparkle = document.createElement('div');
            sparkle.className = 'sparkle';
            sparkle.textContent = emojis[Math.floor(Math.random() * emojis.length)];
            sparkle.style.left = `${centerX + (Math.random() - 0.5) * 80}px`;
            sparkle.style.top = `${centerY + (Math.random() - 0.5) * 60}px`;
            sparkle.style.animationDelay = `${Math.random() * 0.2}s`;
            sparkleContainer.appendChild(sparkle);
            setTimeout(() => sparkle.remove(), 800);
        }
    }

    function changeAnimal(): void {
        const animalKeys = Object.keys(animals);
        const currentIndex = animalKeys.indexOf(currentAnimal);
        currentAnimal = animalKeys[(currentIndex + 1) % animalKeys.length];
        renderAnimal();
        (Object.entries(equippedAccessories) as [AccessoryType, string | null][]).forEach(([type, id]) => {
            if (id) {
                const accessory = getAccessoryById(id);
                const slot = type === 'hat' ? slotHat : type === 'glasses' ? slotGlasses : slotScarf;
                if (accessory) slot.innerHTML = accessory.svg;
            }
        });
    }

    resetBtn?.addEventListener('click', clearAccessories);
    changeAnimalBtn?.addEventListener('click', changeAnimal);

    initGame();
</script>
