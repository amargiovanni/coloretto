---
import GameLayout from '../layouts/GameLayout.astro';
import Header from '../components/Header.astro';
import GameButton from '../components/GameButton.astro';
---

<GameLayout title="Puzzle Semplici">
    <div class="app-container">
        <Header title="Puzzle Semplici">
            <GameButton color="orange" ariaLabel="Prossimo puzzle" id="nextBtn">
                <svg viewBox="0 0 24 24"><path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8-8-8z"/></svg>
            </GameButton>
        </Header>
        <main class="game-container">
            <div class="puzzle-area">
                <div class="puzzle-board" id="puzzleBoard"></div>
                <div class="pieces-area" id="piecesArea"></div>
            </div>
        </main>
        <div class="win-overlay" id="winOverlay">
            <div class="win-content">
                <div class="win-image" id="winImage"></div>
                <h2>Bravissimo!</h2>
                <p>Hai completato il puzzle!</p>
                <button class="win-btn" id="nextPuzzleBtn">Prossimo Puzzle</button>
            </div>
        </div>
        <div class="confetti-container" id="confettiContainer"></div>
    </div>
</GameLayout>

<style>
    .game-container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 15px; gap: 20px; overflow: hidden; }
    .puzzle-area { display: flex; gap: 30px; align-items: center; justify-content: center; flex-wrap: wrap; }
    .puzzle-board { background: white; border-radius: 20px; padding: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; }
    :global(.puzzle-slot) { width: 100px; height: 100px; min-width: 80px; min-height: 80px; background: #e5e7eb; border-radius: 10px; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; position: relative; overflow: hidden; }
    :global(.puzzle-slot.highlight) { background: #d1fae5; box-shadow: inset 0 0 0 3px #22c55e; }
    :global(.puzzle-slot.filled) { background: transparent; }
    :global(.puzzle-slot svg) { width: 100%; height: 100%; }
    .pieces-area { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; max-width: 250px; }
    :global(.puzzle-piece) { width: 95px; height: 95px; min-width: 70px; min-height: 70px; background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: grab; transition: transform 0.2s ease, box-shadow 0.2s ease; touch-action: none; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    :global(.puzzle-piece:active) { cursor: grabbing; }
    :global(.puzzle-piece.dragging) { transform: scale(1.1); box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 100; position: fixed; }
    :global(.puzzle-piece.placed) { opacity: 0; pointer-events: none; transform: scale(0); }
    :global(.puzzle-piece svg) { width: 100%; height: 100%; }
    .win-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: none; align-items: center; justify-content: center; z-index: 1000; }
    :global(.win-overlay.active) { display: flex; }
    .win-content { background: white; border-radius: 25px; padding: 40px; text-align: center; animation: bounceIn 0.5s ease; }
    @keyframes bounceIn { 0% { transform: scale(0); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    .win-content h2 { font-size: 2rem; color: #1f2937; margin-bottom: 10px; }
    .win-content p { font-size: 1.2rem; color: #6b7280; margin-bottom: 25px; }
    .win-image { width: 150px; height: 150px; margin: 0 auto 20px; animation: pulse 1s ease infinite; }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    .win-btn { background: linear-gradient(145deg, #4ade80, #22c55e); color: white; border: none; padding: 15px 40px; font-size: 1.2rem; font-weight: 600; border-radius: 30px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: transform 0.15s ease; }
    .win-btn:active { transform: scale(0.95); }
    .confetti-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1001; }
    :global(.confetti) { position: absolute; width: 12px; height: 12px; animation: confettiFall 2s ease-out forwards; }
    @keyframes confettiFall { 0% { opacity: 1; transform: translateY(-20px) rotate(0deg); } 100% { opacity: 0; transform: translateY(100vh) rotate(720deg); } }

    @media (max-width: 400px) {
        :global(.puzzle-slot) { width: 70px; height: 70px; }
        :global(.puzzle-piece) { width: 65px; height: 65px; }
        .puzzle-board { padding: 8px; gap: 3px; }
        .pieces-area { gap: 8px; max-width: 200px; }
        .puzzle-area { gap: 20px; }
    }

    @media (min-width: 768px) {
        :global(.puzzle-slot) { width: 110px; height: 110px; }
        :global(.puzzle-piece) { width: 105px; height: 105px; }
        .puzzle-board { padding: 12px; gap: 5px; }
        .puzzle-area { gap: 40px; }
        .pieces-area { max-width: 300px; }
    }

    @media (orientation: landscape) and (max-height: 500px) {
        .game-container { padding: 10px; gap: 10px; }
        .puzzle-area { flex-direction: row; gap: 20px; }
        :global(.puzzle-slot) { width: 65px; height: 65px; }
        :global(.puzzle-piece) { width: 60px; height: 60px; }
        .puzzle-board { padding: 6px; gap: 3px; }
        .pieces-area { max-width: 180px; gap: 6px; }
    }
</style>

<script>
    interface PuzzleData {
        name: string;
        pieces: string[];
        fullImage: string;
    }

    const puzzles: PuzzleData[] = [
        {
            name: 'Sole',
            pieces: [
                `<svg viewBox="0 0 50 50"><rect width="50" height="50" fill="#87CEEB"/><path d="M0 25 L25 0 L25 25 Z" fill="#FFD700"/><line x1="5" y1="5" x2="15" y2="15" stroke="#FFA500" stroke-width="3"/></svg>`,
                `<svg viewBox="0 0 50 50"><rect width="50" height="50" fill="#87CEEB"/><path d="M25 0 L50 25 L25 25 Z" fill="#FFD700"/><line x1="45" y1="5" x2="35" y2="15" stroke="#FFA500" stroke-width="3"/></svg>`,
                `<svg viewBox="0 0 50 50"><rect width="50" height="50" fill="#87CEEB"/><path d="M0 25 L25 50 L25 25 Z" fill="#FFD700"/><line x1="5" y1="45" x2="15" y2="35" stroke="#FFA500" stroke-width="3"/></svg>`,
                `<svg viewBox="0 0 50 50"><rect width="50" height="50" fill="#87CEEB"/><path d="M25 25 L50 25 L25 50 Z" fill="#FFD700"/><line x1="45" y1="45" x2="35" y2="35" stroke="#FFA500" stroke-width="3"/></svg>`
            ],
            fullImage: `<svg viewBox="0 0 100 100"><rect width="100" height="100" fill="#87CEEB"/><circle cx="50" cy="50" r="30" fill="#FFD700"/><line x1="50" y1="10" x2="50" y2="0" stroke="#FFA500" stroke-width="4"/><line x1="50" y1="90" x2="50" y2="100" stroke="#FFA500" stroke-width="4"/><line x1="10" y1="50" x2="0" y2="50" stroke="#FFA500" stroke-width="4"/><line x1="90" y1="50" x2="100" y2="50" stroke="#FFA500" stroke-width="4"/><line x1="22" y1="22" x2="15" y2="15" stroke="#FFA500" stroke-width="4"/><line x1="78" y1="22" x2="85" y2="15" stroke="#FFA500" stroke-width="4"/><line x1="22" y1="78" x2="15" y2="85" stroke="#FFA500" stroke-width="4"/><line x1="78" y1="78" x2="85" y2="85" stroke="#FFA500" stroke-width="4"/></svg>`
        },
        {
            name: 'Casa',
            pieces: [
                `<svg viewBox="0 0 50 50"><rect width="50" height="50" fill="#90EE90"/><polygon points="0,50 25,25 50,50" fill="#DC143C"/></svg>`,
                `<svg viewBox="0 0 50 50"><rect width="50" height="50" fill="#90EE90"/><polygon points="0,50 25,25 50,50" fill="#DC143C"/></svg>`,
                `<svg viewBox="0 0 50 50"><rect width="50" height="50" fill="#90EE90"/><rect x="5" y="0" width="40" height="50" fill="#DEB887"/><rect x="15" y="20" width="20" height="30" fill="#8B4513"/></svg>`,
                `<svg viewBox="0 0 50 50"><rect width="50" height="50" fill="#90EE90"/><rect x="5" y="0" width="40" height="50" fill="#DEB887"/><rect x="10" y="10" width="15" height="15" fill="#87CEEB"/><line x1="17.5" y1="10" x2="17.5" y2="25" stroke="#1f2937" stroke-width="2"/><line x1="10" y1="17.5" x2="25" y2="17.5" stroke="#1f2937" stroke-width="2"/></svg>`
            ],
            fullImage: `<svg viewBox="0 0 100 100"><rect width="100" height="100" fill="#90EE90"/><polygon points="50,10 10,50 90,50" fill="#DC143C"/><rect x="20" y="50" width="60" height="45" fill="#DEB887"/><rect x="40" y="65" width="20" height="30" fill="#8B4513"/><rect x="55" y="55" width="15" height="15" fill="#87CEEB"/><line x1="62.5" y1="55" x2="62.5" y2="70" stroke="#1f2937" stroke-width="2"/><line x1="55" y1="62.5" x2="70" y2="62.5" stroke="#1f2937" stroke-width="2"/></svg>`
        },
        {
            name: 'Pesce',
            pieces: [
                `<svg viewBox="0 0 50 50"><rect width="50" height="50" fill="#E0FFFF"/><ellipse cx="50" cy="50" rx="35" ry="25" fill="#FF6347"/></svg>`,
                `<svg viewBox="0 0 50 50"><rect width="50" height="50" fill="#E0FFFF"/><ellipse cx="0" cy="50" rx="35" ry="25" fill="#FF6347"/><circle cx="15" cy="40" r="6" fill="white"/><circle cx="17" cy="40" r="3" fill="#1f2937"/></svg>`,
                `<svg viewBox="0 0 50 50"><rect width="50" height="50" fill="#E0FFFF"/><ellipse cx="50" cy="0" rx="35" ry="25" fill="#FF6347"/><polygon points="50,10 50,40 30,25" fill="#FF4500"/></svg>`,
                `<svg viewBox="0 0 50 50"><rect width="50" height="50" fill="#E0FFFF"/><ellipse cx="0" cy="0" rx="35" ry="25" fill="#FF6347"/><polygon points="0,10 0,40 20,25" fill="#FF4500"/></svg>`
            ],
            fullImage: `<svg viewBox="0 0 100 100"><rect width="100" height="100" fill="#E0FFFF"/><ellipse cx="45" cy="50" rx="35" ry="25" fill="#FF6347"/><polygon points="80,50 100,30 100,70" fill="#FF4500"/><circle cx="30" cy="45" r="6" fill="white"/><circle cx="32" cy="45" r="3" fill="#1f2937"/><path d="M20,55 Q25,60 20,65" stroke="#1f2937" stroke-width="2" fill="none"/></svg>`
        },
        {
            name: 'Fiore',
            pieces: [
                `<svg viewBox="0 0 50 50"><rect width="50" height="50" fill="#98FB98"/><ellipse cx="50" cy="25" rx="20" ry="15" fill="#FF69B4"/><ellipse cx="35" cy="50" rx="15" ry="20" fill="#FF69B4"/></svg>`,
                `<svg viewBox="0 0 50 50"><rect width="50" height="50" fill="#98FB98"/><ellipse cx="0" cy="25" rx="20" ry="15" fill="#FF69B4"/><ellipse cx="15" cy="50" rx="15" ry="20" fill="#FF69B4"/></svg>`,
                `<svg viewBox="0 0 50 50"><rect width="50" height="50" fill="#98FB98"/><ellipse cx="35" cy="0" rx="15" ry="20" fill="#FF69B4"/><circle cx="50" cy="25" r="15" fill="#FFD700"/><rect x="23" y="25" width="6" height="25" fill="#228B22"/></svg>`,
                `<svg viewBox="0 0 50 50"><rect width="50" height="50" fill="#98FB98"/><ellipse cx="15" cy="0" rx="15" ry="20" fill="#FF69B4"/><circle cx="0" cy="25" r="15" fill="#FFD700"/><rect x="21" y="25" width="6" height="25" fill="#228B22"/></svg>`
            ],
            fullImage: `<svg viewBox="0 0 100 100"><rect width="100" height="100" fill="#98FB98"/><ellipse cx="50" cy="20" rx="15" ry="20" fill="#FF69B4"/><ellipse cx="75" cy="40" rx="20" ry="15" fill="#FF69B4"/><ellipse cx="65" cy="70" rx="15" ry="20" fill="#FF69B4"/><ellipse cx="35" cy="70" rx="15" ry="20" fill="#FF69B4"/><ellipse cx="25" cy="40" rx="20" ry="15" fill="#FF69B4"/><circle cx="50" cy="45" r="15" fill="#FFD700"/><rect x="47" y="55" width="6" height="35" fill="#228B22"/></svg>`
        },
        {
            name: 'Farfalla',
            pieces: [
                `<svg viewBox="0 0 50 50"><rect width="50" height="50" fill="#FFF8DC"/><ellipse cx="50" cy="50" rx="30" ry="25" fill="#9370DB"/><circle cx="35" cy="40" r="8" fill="#FFD700"/></svg>`,
                `<svg viewBox="0 0 50 50"><rect width="50" height="50" fill="#FFF8DC"/><ellipse cx="0" cy="50" rx="30" ry="25" fill="#9370DB"/><circle cx="15" cy="40" r="8" fill="#FFD700"/></svg>`,
                `<svg viewBox="0 0 50 50"><rect width="50" height="50" fill="#FFF8DC"/><ellipse cx="50" cy="0" rx="25" ry="20" fill="#DDA0DD"/><ellipse cx="45" cy="25" rx="5" ry="20" fill="#4B0082"/></svg>`,
                `<svg viewBox="0 0 50 50"><rect width="50" height="50" fill="#FFF8DC"/><ellipse cx="0" cy="0" rx="25" ry="20" fill="#DDA0DD"/><ellipse cx="5" cy="25" rx="5" ry="20" fill="#4B0082"/><circle cx="10" cy="10" r="4" fill="#1f2937"/></svg>`
            ],
            fullImage: `<svg viewBox="0 0 100 100"><rect width="100" height="100" fill="#FFF8DC"/><ellipse cx="50" cy="55" rx="5" ry="25" fill="#4B0082"/><circle cx="50" cy="25" r="8" fill="#4B0082"/><ellipse cx="25" cy="45" rx="20" ry="25" fill="#9370DB"/><ellipse cx="75" cy="45" rx="20" ry="25" fill="#9370DB"/><ellipse cx="30" cy="75" rx="15" ry="18" fill="#DDA0DD"/><ellipse cx="70" cy="75" rx="15" ry="18" fill="#DDA0DD"/><circle cx="25" cy="40" r="6" fill="#FFD700"/><circle cx="75" cy="40" r="6" fill="#FFD700"/><line x1="45" y1="18" x2="35" y2="5" stroke="#4B0082" stroke-width="2"/><line x1="55" y1="18" x2="65" y2="5" stroke="#4B0082" stroke-width="2"/><circle cx="35" cy="4" r="3" fill="#4B0082"/><circle cx="65" cy="4" r="3" fill="#4B0082"/></svg>`
        },
        {
            name: 'Macchinina',
            pieces: [
                `<svg viewBox="0 0 50 50"><rect width="50" height="50" fill="#B0C4DE"/><path d="M0,35 L15,35 L25,20 L50,20 L50,35" fill="#FF0000"/></svg>`,
                `<svg viewBox="0 0 50 50"><rect width="50" height="50" fill="#B0C4DE"/><path d="M0,20 L25,20 L35,35 L50,35" fill="#FF0000"/><rect x="5" y="22" width="18" height="12" fill="#87CEEB"/></svg>`,
                `<svg viewBox="0 0 50 50"><rect width="50" height="50" fill="#B0C4DE"/><rect x="0" y="0" width="50" height="15" fill="#FF0000"/><circle cx="15" cy="15" r="12" fill="#1f2937"/><circle cx="15" cy="15" r="6" fill="#696969"/></svg>`,
                `<svg viewBox="0 0 50 50"><rect width="50" height="50" fill="#B0C4DE"/><rect x="0" y="0" width="50" height="15" fill="#FF0000"/><circle cx="35" cy="15" r="12" fill="#1f2937"/><circle cx="35" cy="15" r="6" fill="#696969"/></svg>`
            ],
            fullImage: `<svg viewBox="0 0 100 100"><rect width="100" height="100" fill="#B0C4DE"/><rect x="10" y="40" width="80" height="25" fill="#FF0000"/><path d="M25,40 L35,25 L65,25 L75,40" fill="#FF0000"/><rect x="38" y="28" width="24" height="12" fill="#87CEEB"/><circle cx="30" cy="65" r="12" fill="#1f2937"/><circle cx="30" cy="65" r="6" fill="#696969"/><circle cx="70" cy="65" r="12" fill="#1f2937"/><circle cx="70" cy="65" r="6" fill="#696969"/></svg>`
        }
    ];

    let currentPuzzleIndex: number = 0;
    let placedPieces: boolean[] = [false, false, false, false];
    let draggedPiece: HTMLElement | null = null;

    const puzzleBoard = document.getElementById('puzzleBoard')!;
    const piecesArea = document.getElementById('piecesArea')!;
    const resetBtn = document.getElementById('resetBtn');
    const nextBtn = document.getElementById('nextBtn');
    const winOverlay = document.getElementById('winOverlay')!;
    const winImage = document.getElementById('winImage')!;
    const nextPuzzleBtn = document.getElementById('nextPuzzleBtn');
    const confettiContainer = document.getElementById('confettiContainer')!;

    function initGame(): void {
        placedPieces = [false, false, false, false];
        winOverlay.classList.remove('active');
        renderPuzzle();
    }

    function renderPuzzle(): void {
        const puzzle = puzzles[currentPuzzleIndex];
        puzzleBoard.innerHTML = '';
        for (let i = 0; i < 4; i++) {
            const slot = document.createElement('div');
            slot.className = 'puzzle-slot';
            slot.dataset.index = String(i);
            puzzleBoard.appendChild(slot);
        }
        piecesArea.innerHTML = '';
        const shuffledIndices = [0, 1, 2, 3].sort(() => Math.random() - 0.5);
        shuffledIndices.forEach((originalIndex: number) => {
            const piece = document.createElement('div');
            piece.className = 'puzzle-piece';
            piece.dataset.index = String(originalIndex);
            piece.innerHTML = puzzle.pieces[originalIndex];
            addDragListeners(piece);
            piecesArea.appendChild(piece);
        });
    }

    function addDragListeners(piece: HTMLElement): void {
        piece.addEventListener('touchstart', handleDragStart, { passive: false });
        piece.addEventListener('touchmove', handleDragMove, { passive: false });
        piece.addEventListener('touchend', handleDragEnd, { passive: false });
        piece.addEventListener('mousedown', handleDragStart);
    }

    function handleDragStart(e: TouchEvent | MouseEvent): void {
        if (e.type === 'mousedown') { document.addEventListener('mousemove', handleDragMove); document.addEventListener('mouseup', handleDragEnd); }
        e.preventDefault();
        draggedPiece = e.currentTarget as HTMLElement;
        draggedPiece.classList.add('dragging');
        const clientX = e instanceof TouchEvent ? e.touches[0].clientX : e.clientX;
        const clientY = e instanceof TouchEvent ? e.touches[0].clientY : e.clientY;
        updateDragPosition(clientX, clientY);
    }

    function handleDragMove(e: TouchEvent | MouseEvent): void {
        if (!draggedPiece) return;
        e.preventDefault();
        const clientX = e instanceof TouchEvent ? e.touches[0].clientX : e.clientX;
        const clientY = e instanceof TouchEvent ? e.touches[0].clientY : e.clientY;
        updateDragPosition(clientX, clientY);
        checkSlotHighlight(clientX, clientY);
    }

    function updateDragPosition(x: number, y: number): void {
        if (!draggedPiece) return;
        draggedPiece.style.left = `${x - draggedPiece.offsetWidth / 2}px`;
        draggedPiece.style.top = `${y - draggedPiece.offsetHeight / 2}px`;
    }

    function handleDragEnd(e: TouchEvent | MouseEvent): void {
        if (!draggedPiece) return;
        const clientX = e instanceof TouchEvent ? e.changedTouches[0].clientX : e.clientX;
        const clientY = e instanceof TouchEvent ? e.changedTouches[0].clientY : e.clientY;
        const slot = getSlotAtPosition(clientX, clientY);
        const pieceIndex = parseInt(draggedPiece.dataset.index || '0');
        if (slot) {
            const slotIndex = parseInt(slot.dataset.index || '0');
            if (pieceIndex === slotIndex && !placedPieces[slotIndex]) {
                placedPieces[slotIndex] = true;
                slot.classList.add('filled');
                slot.innerHTML = puzzles[currentPuzzleIndex].pieces[pieceIndex];
                draggedPiece.classList.add('placed');
                if (placedPieces.every((p: boolean) => p)) setTimeout(showWin, 300);
            }
        }
        draggedPiece.style.left = ''; draggedPiece.style.top = '';
        draggedPiece.classList.remove('dragging');
        draggedPiece = null;
        document.querySelectorAll('.puzzle-slot').forEach((s) => s.classList.remove('highlight'));
        document.removeEventListener('mousemove', handleDragMove);
        document.removeEventListener('mouseup', handleDragEnd);
    }

    function checkSlotHighlight(x: number, y: number): void {
        document.querySelectorAll<HTMLElement>('.puzzle-slot').forEach((slot) => {
            if (slot.classList.contains('filled')) return;
            const rect = slot.getBoundingClientRect();
            const isOver = x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom;
            slot.classList.toggle('highlight', isOver);
        });
    }

    function getSlotAtPosition(x: number, y: number): HTMLElement | null {
        const slots = document.querySelectorAll<HTMLElement>('.puzzle-slot');
        for (const slot of slots) {
            const rect = slot.getBoundingClientRect();
            if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) return slot;
        }
        return null;
    }

    function showWin(): void {
        winImage.innerHTML = puzzles[currentPuzzleIndex].fullImage;
        winOverlay.classList.add('active');
        createConfetti();
    }

    function createConfetti(): void {
        const colors: string[] = ['#ef4444', '#f59e0b', '#22c55e', '#3b82f6', '#8b5cf6', '#ec4899'];
        for (let i = 0; i < 50; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = `${Math.random() * 100}%`;
            confetti.style.top = '-20px';
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
            confetti.style.animationDelay = `${Math.random() * 0.5}s`;
            confetti.style.animationDuration = `${1.5 + Math.random()}s`;
            confettiContainer.appendChild(confetti);
            setTimeout(() => confetti.remove(), 2500);
        }
    }

    function nextPuzzle(): void {
        currentPuzzleIndex = (currentPuzzleIndex + 1) % puzzles.length;
        initGame();
    }

    resetBtn?.addEventListener('click', initGame);
    nextBtn?.addEventListener('click', nextPuzzle);
    nextPuzzleBtn?.addEventListener('click', nextPuzzle);

    initGame();
</script>
