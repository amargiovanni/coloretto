---
import GameLayout from '../layouts/GameLayout.astro';
import Header from '../components/Header.astro';
---

<GameLayout title="Trova le Forme">
    <div class="app-container">
        <Header title="Trova le Forme">
            <div class="score-display"><span id="matchedCount">0</span> / <span id="totalCount">6</span></div>
            <button class="btn btn-reset" id="resetBtn" aria-label="Ricomincia">
                <svg viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
            </button>
        </Header>
        <main class="game-container">
            <div class="game-area">
                <div class="shapes-column" id="shapesColumn"></div>
                <div class="shapes-column" id="targetsColumn"></div>
            </div>
        </main>
        <div class="confetti-container" id="confettiContainer"></div>
        <div class="modal-overlay" id="winModal">
            <div class="modal-content"><h2>Fantastico!</h2><p>Hai abbinato tutte le forme!</p><button class="modal-btn" id="playAgainBtn">Gioca Ancora</button></div>
        </div>
    </div>
</GameLayout>

<style>
    .score-display { background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px; color: white; font-weight: 600; }
    .game-container { flex: 1; display: flex; align-items: center; justify-content: center; padding: 15px; }
    .game-area { display: flex; justify-content: space-around; align-items: center; width: 100%; max-width: 700px; gap: 20px; }
    .shapes-column { display: flex; flex-direction: column; gap: 15px; align-items: center; }
    :global(.shape-item) { width: 90px; height: 90px; min-width: 70px; min-height: 70px; background: white; border-radius: 15px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 20px rgba(0,0,0,0.2); cursor: grab; transition: transform 0.2s, box-shadow 0.2s; touch-action: none; }
    :global(.shape-item.dragging) { transform: scale(1.1); box-shadow: 0 8px 30px rgba(0,0,0,0.3); z-index: 100; }
    :global(.shape-item.matched) { opacity: 0; transform: scale(0); pointer-events: none; }
    :global(.shape-item svg) { width: 65px; height: 65px; }
    :global(.target-zone) { width: 100px; height: 100px; min-width: 70px; min-height: 70px; border: 4px dashed rgba(255,255,255,0.5); border-radius: 20px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    :global(.target-zone.highlight) { border-color: #4ade80; background: rgba(74,222,128,0.2); transform: scale(1.1); }
    :global(.target-zone.matched) { border-color: #4ade80; background: rgba(74,222,128,0.3); border-style: solid; }
    :global(.target-zone svg) { width: 50px; height: 50px; opacity: 0.3; }
    :global(.target-zone.matched svg) { opacity: 1; }
    .confetti-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000; }
    :global(.confetti) { position: absolute; width: 10px; height: 10px; animation: confettiFall 1.5s ease-out forwards; }
    @keyframes confettiFall { 0% { opacity: 1; transform: translateY(0) rotate(0); } 100% { opacity: 0; transform: translateY(200px) rotate(720deg); } }
    .modal-content { text-align: center; padding: 40px; }
    .modal-content h2 { font-size: 2rem; margin-bottom: 15px; color: #1f2937; }
    .modal-content p { font-size: 1.2rem; color: #6b7280; margin-bottom: 25px; }
</style>

<script>
    interface ShapeData {
        color: string;
        svg: string;
    }

    const shapes: Record<string, ShapeData> = {
        circle: { color: '#ef4444', svg: `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="#ef4444"/></svg>` },
        square: { color: '#3b82f6', svg: `<svg viewBox="0 0 100 100"><rect x="10" y="10" width="80" height="80" rx="5" fill="#3b82f6"/></svg>` },
        triangle: { color: '#22c55e', svg: `<svg viewBox="0 0 100 100"><polygon points="50,10 90,90 10,90" fill="#22c55e"/></svg>` },
        star: { color: '#fbbf24', svg: `<svg viewBox="0 0 100 100"><polygon points="50,5 61,40 98,40 68,62 79,97 50,75 21,97 32,62 2,40 39,40" fill="#fbbf24"/></svg>` },
        heart: { color: '#ec4899', svg: `<svg viewBox="0 0 100 100"><path d="M50 88 C20 60 5 45 5 30 C5 15 20 5 35 5 C45 5 50 15 50 15 C50 15 55 5 65 5 C80 5 95 15 95 30 C95 45 80 60 50 88" fill="#ec4899"/></svg>` },
        hexagon: { color: '#8b5cf6', svg: `<svg viewBox="0 0 100 100"><polygon points="50,5 93,27 93,73 50,95 7,73 7,27" fill="#8b5cf6"/></svg>` }
    };

    let matched: number = 0, draggedElement: HTMLElement | null = null;
    const shapesColumn = document.getElementById('shapesColumn')!;
    const targetsColumn = document.getElementById('targetsColumn')!;
    const matchedCount = document.getElementById('matchedCount')!;
    const totalCount = document.getElementById('totalCount')!;
    const confettiContainer = document.getElementById('confettiContainer')!;
    const winModal = document.getElementById('winModal')!;

    function initGame(): void {
        matched = 0; matchedCount.textContent = String(matched); winModal.classList.remove('active');
        const keys = Object.keys(shapes); totalCount.textContent = String(keys.length);
        shapesColumn.innerHTML = ''; targetsColumn.innerHTML = '';
        [...keys].sort(() => Math.random() - 0.5).forEach((key: string) => {
            const el = document.createElement('div'); el.className = 'shape-item'; el.dataset.shape = key;
            el.innerHTML = shapes[key].svg; addDrag(el); shapesColumn.appendChild(el);
        });
        [...keys].sort(() => Math.random() - 0.5).forEach((key: string) => {
            const el = document.createElement('div'); el.className = 'target-zone'; el.dataset.shape = key;
            el.innerHTML = shapes[key].svg; targetsColumn.appendChild(el);
        });
    }

    function addDrag(el: HTMLElement): void {
        el.addEventListener('mousedown', startDrag); el.addEventListener('touchstart', startDrag, { passive: false });
    }

    function startDrag(e: MouseEvent | TouchEvent): void {
        e.preventDefault(); draggedElement = e.currentTarget as HTMLElement; draggedElement.classList.add('dragging');
        document.addEventListener('mousemove', moveDrag); document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchmove', moveDrag, { passive: false }); document.addEventListener('touchend', endDrag);
        const touch = e instanceof TouchEvent ? e.touches[0] : e;
        const { clientX, clientY } = touch;
        draggedElement.style.position = 'fixed';
        draggedElement.style.left = `${clientX - 40}px`; draggedElement.style.top = `${clientY - 40}px`;
    }

    function moveDrag(e: MouseEvent | TouchEvent): void {
        if (!draggedElement) return; e.preventDefault();
        const touch = e instanceof TouchEvent ? e.touches[0] : e;
        const { clientX, clientY } = touch;
        draggedElement.style.left = `${clientX - 40}px`; draggedElement.style.top = `${clientY - 40}px`;
        document.querySelectorAll<HTMLElement>('.target-zone:not(.matched)').forEach((t) => {
            const r = t.getBoundingClientRect();
            t.classList.toggle('highlight', clientX >= r.left && clientX <= r.right && clientY >= r.top && clientY <= r.bottom);
        });
    }

    function endDrag(e: MouseEvent | TouchEvent): void {
        if (!draggedElement) return;
        const touch = e instanceof TouchEvent ? e.changedTouches[0] : e;
        const { clientX, clientY } = touch;
        const target = [...document.querySelectorAll<HTMLElement>('.target-zone:not(.matched)')].find((t) => {
            const r = t.getBoundingClientRect();
            return clientX >= r.left && clientX <= r.right && clientY >= r.top && clientY <= r.bottom;
        });
        if (target && draggedElement.dataset.shape === target.dataset.shape) {
            matched++; matchedCount.textContent = String(matched);
            draggedElement.classList.add('matched'); target.classList.add('matched');
            createConfetti(target);
            if (matched === Object.keys(shapes).length) setTimeout(() => winModal.classList.add('active'), 500);
        }
        draggedElement.style.position = ''; draggedElement.style.left = ''; draggedElement.style.top = '';
        draggedElement.classList.remove('dragging'); draggedElement = null;
        document.querySelectorAll('.target-zone').forEach((t) => t.classList.remove('highlight'));
        document.removeEventListener('mousemove', moveDrag); document.removeEventListener('mouseup', endDrag);
        document.removeEventListener('touchmove', moveDrag); document.removeEventListener('touchend', endDrag);
    }

    function createConfetti(target: HTMLElement): void {
        const r = target.getBoundingClientRect(), cx = r.left + r.width/2, cy = r.top + r.height/2;
        const colors: string[] = ['#ef4444', '#3b82f6', '#22c55e', '#fbbf24', '#ec4899', '#8b5cf6'];
        for (let i = 0; i < 15; i++) {
            const c = document.createElement('div'); c.className = 'confetti';
            c.style.left = `${cx + (Math.random()-0.5)*100}px`; c.style.top = `${cy}px`;
            c.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)];
            confettiContainer.appendChild(c); setTimeout(() => c.remove(), 1500);
        }
    }

    document.getElementById('resetBtn')!.addEventListener('click', initGame);
    document.getElementById('playAgainBtn')!.addEventListener('click', initGame);
    initGame();
</script>
